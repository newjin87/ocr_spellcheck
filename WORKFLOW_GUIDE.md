# 🚀 순차 워크플로우 - 사용 설명서

## 📋 전체 흐름도

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           🎯 워크플로우 시작                                  │
└─────────────────────────────────────────────────────────────────────────────┘

1️⃣ 📤 PDF 파일 업로드
   ↓ (OCR 자동 처리)
   
2️⃣ 📝 [원본 글 탭] OCR 결과 확인 & 수정
   ├─ 추출된 텍스트 편집
   └─ ✅ "원본 저장" 클릭
      ↓
      
3️⃣ 🚀 중앙의 "글 고쳐쓰기 시작" 버튼 클릭
   ↓ (workflow_started = True)
   │
   ├─────────────────────────────────────────────────┐
   │                                                  │
4️⃣ 🔍 [맞춤법 교정 탭] - Tab2 활성화                  │
   │  ┌─────────────────────────────────────────┐   │
   │  │ 원본 글 기반 맞춤법 검사 자동 실행       │   │
   │  │ (session_state['original_text'] 사용)   │   │
   │  └─────────────────────────────────────────┘   │
   │                                                  │
   │  ✏️ 글 편집 가능:                               │
   │  │  ├─ 💾 "저장" → draft_after_spell 저장  │
   │  │  ├─ 🔎 "다시 검사" → 오류 목록 업데이트 │
   │  │  │                  (spell_check_result갱신) │
   │  │  └─ ➡️ "다음 단계로" 클릭               │
   │  │           ↓ (proceed_to_writing = True)     │
   │  │           + st.rerun() 페이지 새로고침     │
   │  │                                              │
   │  └─────────────────────────────────────────┘   │
   │                                                  │
5️⃣ ✍️ [글쓰기 교정 탭] - Tab3 활성화                 │
   │  (proceed_to_writing=True일 때만)              │
   │  ┌─────────────────────────────────────────┐   │
   │  │ draft_after_spell 기반 글쓰기 교정       │
   │  │ (저장된 맞춤법 교정 결과 입력으로 사용)  │
   │  └─────────────────────────────────────────┘   │
   │                                                  │
   │  ✏️ 글 편집 가능:                               │
   │  │  ├─ 💾 "저장" → draft_after_writing 저장│
   │  │  ├─ 🔎 "다시 평가" → 피드백 업데이트   │
   │  │  │                  (writing_feedback_for_current갱신) │
   │  │  │                  위의 평가 섹션에 즉시 표시          │
   │  │  └─ ✅ "완성!" 클릭                    │
   │  │           ↓ (final_text = draft_after_writing) │
   │  │           (workflow_completed = True)    │
   │  │           + st.rerun() 페이지 새로고침   │
   │  │                                              │
   │  └─────────────────────────────────────────┘   │
   │                                                  │
   └─────────────────────────────────────────────────┘
                        ↓

6️⃣ 📊 최종 결과 비교 뷰 (자동 표시)
   ├─ 📄 왼쪽: 원본 글
   ├─ ✨ 오른쪽: 완성된 글
   ├─ 📥 다운로드 버튼 (원본, 완성본)
   └─ 🔄 "다시 시작" 버튼 (모든 상태 초기화)
```

---

## 🔧 세부 기능 설명

### **Tab 2: 맞춤법 교정**

| 기능 | 입력 | 출력 | 저장 |
|------|------|------|------|
| 초기 실행 | `original_text` | 맞춤법 오류 목록 | `spell_check_result` |
| 글 편집 | 사용자 수정 글 | (편집 가능한 영역) | `draft_after_spell` |
| 다시 검사 | 수정된 글 | 업데이트된 오류 목록 | `spell_check_result` |
| 다음 단계로 | `draft_after_spell` | Tab3 활성화 | `proceed_to_writing=True` |

**중요:** "다시 검사" 후 `st.rerun()`이 호출되어 페이지가 새로고침되고 업데이트된 오류 목록이 표시됨

---

### **Tab 3: 글쓰기 교정**

| 기능 | 입력 | 출력 | 저장 |
|------|------|------|------|
| 초기 실행 | `draft_after_spell` | 교사 평가 + 제안 | `writing_feedback_for_current` |
| 글 편집 | 사용자 수정 글 | (편집 가능한 영역) | `draft_after_writing` |
| 다시 평가 | 수정된 글 | 업데이트된 피드백 | `writing_feedback_for_current` |
| 완성 | `draft_after_writing` | 최종 비교 뷰 | `final_text=draft_after_writing` |

**중요:** "다시 평가" 후 `st.rerun()`이 호출되어 위의 "평가 및 제안" 섹션에 새로운 피드백이 즉시 표시됨

---

## 📊 세션 상태 변수

```python
# 워크플로우 제어 플래그
workflow_started: bool         # Tab2 활성화 여부
proceed_to_writing: bool       # Tab3 활성화 여부
workflow_completed: bool       # 최종 뷰 표시 여부

# 텍스트 저장소
original_text: str             # 원본 글 (원본 탭에서 저장)
draft_after_spell: str         # 맞춤법 교정 후 글
draft_after_writing: str       # 글쓰기 교정 후 글
final_text: str                # 최종 완성본

# 분석 결과
spell_check_result: list       # 맞춤법 검사 결과 JSON
writing_feedback_for_current: str  # 현재 글쓰기 교정 피드백
```

---

## ✨ 주요 개선 사항

### 1. 다음 단계로 버튼 작동
- ✅ Tab3 조건을 `proceed_to_writing=True`로만 제한
- ✅ 사용자가 명시적으로 "다음 단계로" 클릭 시에만 Tab3 활성화

### 2. 저장된 원본 기반 교정
- ✅ Tab2: `original_text` → `draft_after_spell`
- ✅ Tab3: `draft_after_spell` → `draft_after_writing`
- ✅ 각 단계의 편집이 다음 단계로 전파

### 3. 재검사/재평가 시 글 전파
- ✅ Tab2 "다시 검사": `spell_check_result` 업데이트 + `st.rerun()`
- ✅ Tab3 "다시 평가": `writing_feedback_for_current` 업데이트 + `st.rerun()`
- ✅ 페이지 새로고침으로 즉시 반영

---

## 🎯 사용 팁

1. **각 단계에서 "저장" 필수**: 편집 후 반드시 "저장" 버튼을 클릭해야 다음 단계에 반영
2. **"다시 검사/평가" 활용**: 글을 수정한 후 다시 검사하면 최신 피드백 획득
3. **"완성!" 버튼**: 최종 내용이 확정된 후에 클릭 (이후 수정 불가)

---

## 🐛 문제 해결

| 증상 | 원인 | 해결책 |
|------|------|--------|
| Tab3이 표시되지 않음 | "다음 단계로" 미클릭 | Tab2에서 "다음 단계로" 버튼 클릭 |
| 편집한 글이 다음 단계에 반영 안 됨 | "저장" 버튼 미클릭 | 각 탭에서 "저장" 버튼 반드시 클릭 |
| 오류 목록이 업데이트 안 됨 | 재검사 후 페이지 새로고침 안 됨 | "다시 검사" 클릭 후 자동 새로고침 확인 |
| 피드백이 업데이트 안 됨 | 재평가 후 페이지 새로고침 안 됨 | "다시 평가" 클릭 후 자동 새로고침 확인 |

---

**수정 완료 날짜**: 2025-11-12  
**커밋**: `ddc7566` - fix: 순차 워크플로우 버그 수정
